<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Iradori Practice Lesson — Interactive HTML (Mic & ASR)</title>
    <style>
        :root {
            --bg: #f7fafc;
            --card: #ffffff;
            --accent: #2b6cb0;
            --muted: #6b7280
        }

        body {
            font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif;
            background: var(--bg);
            color: #0f172a;
            padding: 20px
        }

        .container {
            max-width: 900px;
            margin: 0 auto
        }

        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 18px
        }

        h1 {
            font-size: 20px;
            margin: 0
        }

        .card {
            background: var(--card);
            border-radius: 12px;
            padding: 18px;
            box-shadow: 0 6px 18px rgba(2, 6, 23, 0.06);
            margin-bottom: 12px
        }

        .controls button {
            margin-right: 8px;
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid #e6eef8;
            background: white;
            cursor: pointer
        }

        .sentence {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px dashed #eef2f7
        }

        .text {
            flex: 1
        }

        .jp {
            font-size: 18px;
            font-weight: 600
        }

        .romaji,
        .sinhala {
            font-size: 14px;
            color: var(--muted);
            margin-top: 6px
        }

        .small {
            font-size: 13px;
            color: var(--muted)
        }

        .actions button {
            margin-left: 8px
        }

        .hidden {
            display: none
        }

        footer {
            margin-top: 18px;
            font-size: 13px;
            color: var(--muted)
        }

        .exercise .choice {
            display: inline-block;
            margin: 6px 8px;
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid #e6eef8;
            background: #fff;
            cursor: pointer
        }

        .exercise .choice.selected {
            border-color: var(--accent);
            background: linear-gradient(90deg, #e6f2ff, white)
        }

        .asr-result {
            margin-top: 8px;
            font-weight: 600
        }

        .asr-correct {
            color: green
        }

        .asr-wrong {
            color: #b91c1c
        }

        .mic-status {
            font-size: 13px;
            color: var(--muted);
            margin-left: 8px
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>Iradori Practice — Interactive Lesson (Mic & Speech Recognition)</h1>
            <div class="controls">
                <button id="toggleRomaji">Toggle Romaji</button>
                <button id="toggleSinhala">Toggle Sinhala</button>
                <button id="readAll">Read all (TTS)</button>
            </div>
        </header>

        <section class="card" id="phrases">
            <h2 style="margin-top:0">Practice Phrases (Tap ▶ and then Start to speak)</h2>

            <!-- sentence template -->
            <div class="sentence" data-index="1">
                <div class="text">
                    <div class="jp">おはようございます。</div>
                    <div class="romaji hidden">Ohayou gozaimasu.</div>
                    <div class="sinhala hidden">Subha udēsanak (සුභ උදේසනක්)</div>
                    <div class="asr-result" id="result-1"></div>
                </div>
                <div class="actions">
                    <button class="play">▶</button>
                    <button class="start-asr">Start</button>
                    <span class="mic-status" id="mic-1"></span>
                </div>
            </div>

            <div class="sentence" data-index="2">
                <div class="text">
                    <div class="jp">どうも、ありがとうございます。</div>
                    <div class="romaji hidden">Doumo, arigatou gozaimasu.</div>
                    <div class="sinhala hidden">Bohoma sthuthi (බොහෝම ස්තුති)</div>
                    <div class="asr-result" id="result-2"></div>
                </div>
                <div class="actions"><button class="play">▶</button><button class="start-asr">Start</button><span
                        class="mic-status" id="mic-2"></span></div>
            </div>

            <div class="sentence" data-index="3">
                <div class="text">
                    <div class="jp">すみません、失礼します。</div>
                    <div class="romaji hidden">Sumimasen, shitsurei shimasu.</div>
                    <div class="sinhala hidden">Samā wenna, samāvendā (සමාවෙන්න, සුමාවෙන්)</div>
                    <div class="asr-result" id="result-3"></div>
                </div>
                <div class="actions"><button class="play">▶</button><button class="start-asr">Start</button><span
                        class="mic-status" id="mic-3"></span></div>
            </div>

            <div class="sentence" data-index="4">
                <div class="text">
                    <div class="jp">おやすみなさい。</div>
                    <div class="romaji hidden">Oyasuminasai.</div>
                    <div class="sinhala hidden">Subha nidā (සුභ නිදා)</div>
                    <div class="asr-result" id="result-4"></div>
                </div>
                <div class="actions"><button class="play">▶</button><button class="start-asr">Start</button><span
                        class="mic-status" id="mic-4"></span></div>
            </div>

        </section>

        <section class="card exercise" id="exercise">
            <h2 style="margin-top:0">Quick Exercise — Choose correct greeting</h2>
            <p class="small">Situation: 朝に友だちに会ったとき、どの挨拶を送りますか？</p>
            <div id="choices">
                <div class="choice" data-value="a">おはよう</div>
                <div class="choice" data-value="b">こんにちは</div>
                <div class="choice" data-value="c">こんばんは</div>
                <div class="choice" data-value="d">おやすみ</div>
            </div>
            <div style="margin-top:10px">
                <button id="checkAnswer">Check answer</button>
                <span id="answerText" class="small" style="margin-left:10px"></span>
            </div>
        </section>

        <footer>
            Tip: Click "Start" to begin speech recognition for that phrase. The browser will ask permission to use the
            microphone. The page compares your recognized phrase to the target and shows basic feedback.
            SpeechRecognition support varies by browser (Chrome/Edge are best supported).
        </footer>
    </div>

    <script>
        // Toggle display helpers
        function toggleClassAll(selector, cls) {
            document.querySelectorAll(selector).forEach(el => el.classList.toggle(cls));
        }

        document.getElementById('toggleRomaji').addEventListener('click', function () {
            toggleClassAll('.romaji', 'hidden');
        });
        document.getElementById('toggleSinhala').addEventListener('click', function () {
            toggleClassAll('.sinhala', 'hidden');
        });

        // TTS speak
        function speak(text) {
            if (!('speechSynthesis' in window)) { alert('SpeechSynthesis not supported in this browser.'); return; }
            var ut = new SpeechSynthesisUtterance(text);
            ut.lang = 'ja-JP';
            var voices = speechSynthesis.getVoices();
            for (var i = 0; i < voices.length; i++) {
                if (voices[i].lang.indexOf('ja') === 0) { ut.voice = voices[i]; break; }
            }
            window.speechSynthesis.cancel();
            window.speechSynthesis.speak(ut);
        }

        document.querySelectorAll('.sentence').forEach(function (node) {
            node.querySelector('.play').addEventListener('click', function () {
                var jp = node.querySelector('.jp').textContent.trim();
                speak(jp);
            });
        });

        // Read all
        document.getElementById('readAll').addEventListener('click', function () {
            var texts = Array.from(document.querySelectorAll('.sentence .jp')).map(n => n.textContent.trim()).join(' ');
            speak(texts);
        });

        // Exercise choice selection
        document.querySelectorAll('#choices .choice').forEach(function (choice) {
            choice.addEventListener('click', function () {
                document.querySelectorAll('#choices .choice').forEach(c => c.classList.remove('selected'));
                choice.classList.add('selected');
                document.getElementById('answerText').textContent = '';
            });
        });

        document.getElementById('checkAnswer').addEventListener('click', function () {
            var sel = document.querySelector('#choices .choice.selected');
            var out = document.getElementById('answerText');
            if (!sel) { out.textContent = 'Please select a choice.'; return; }
            if (sel.dataset.value === 'a') {
                out.textContent = 'Correct — おはよう (Morning greeting).';
            } else {
                out.textContent = 'Not correct. The best choice is おはよう for morning.';
            }
        });

        // --- Speech Recognition (ASR) setup ---
        // Use webkitSpeechRecognition where available (Chrome / Edge)
        var SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition || null;

        function normalizeForCompare(s) {
            return s.toLowerCase().replace(/[\u3000\s\.,!?\-\"'«»\(\)\[\]_]/g, '').replace(/ー/g, '').replace(/。/g, '').trim();
        }

        document.querySelectorAll('.sentence').forEach(function (node) {
            var startBtn = node.querySelector('.start-asr');
            var resEl = node.querySelector('.asr-result');
            var micEl = node.querySelector('.mic-status');
            var target = node.querySelector('.jp').textContent.trim();

            startBtn.addEventListener('click', function () {
                resEl.textContent = '';
                micEl.textContent = '';

                if (!SpeechRecognition) {
                    // fallback: ask for mic permission to show user flow
                    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                        navigator.mediaDevices.getUserMedia({ audio: true }).then(function (stream) {
                            micEl.textContent = 'Microphone access granted (no ASR). Use Chrome/Edge for recognition.';
                            stream.getTracks().forEach(t => t.stop());
                        }).catch(function (err) { micEl.textContent = 'Microphone permission denied.'; });
                    } else {
                        micEl.textContent = 'SpeechRecognition not supported in this browser.';
                    }
                    return;
                }

                // create recognition instance per start (simple flow)
                var recog = new SpeechRecognition();
                recog.lang = 'ja-JP';
                recog.interimResults = false;
                recog.maxAlternatives = 3;

                recog.onstart = function () { micEl.textContent = 'Listening...'; };
                recog.onerror = function (e) { micEl.textContent = 'Error: ' + (e.error || e.message || 'unknown'); };
                recog.onend = function () { if (micEl.textContent === 'Listening...') micEl.textContent = 'Stopped.'; };

                recog.onresult = function (ev) {
                    var transcript = '';
                    for (var i = 0; i < ev.results.length; i++) {
                        transcript += ev.results[i][0].transcript + ' ';
                    }
                    transcript = transcript.trim();

                    // show recognized text
                    resEl.innerHTML = 'Recognized: <span class="small">' + transcript + '</span>';

                    // compare normalized strings (very simple compare)
                    var normRec = normalizeForCompare(transcript);
                    var normTarget = normalizeForCompare(target);

                    if (normRec === normTarget || normTarget.indexOf(normRec) !== -1 || normRec.indexOf(normTarget) !== -1) {
                        resEl.innerHTML += ' <span class="asr-correct">✔ Good match</span>';
                        // optional: praise
                        speak('よくできました。');
                    } else {
                        resEl.innerHTML += ' <span class="asr-wrong">✖ Not exact</span>';
                        // show hint: play target
                        speak(target);
                    }
                };

                try { recog.start(); } catch (err) { micEl.textContent = 'Recognition start failed: ' + err.message; }
            });
        });

        // Ensure voices loaded for some browsers
        if (speechSynthesis && speechSynthesis.getVoices().length === 0) {
            speechSynthesis.addEventListener('voiceschanged', function () { });
        }
    </script>
</body>

</html>